<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Christmas Countdown</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<style>
html, body {
    margin: 0; padding: 0;
    height: 100%; width: 100%;
    background: #000;
    overflow: hidden;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    cursor: none;
}
#visual-layer {
    position: fixed;
    top: -10%; left: -10%;
    width: 120%; height: 120%;
    background: url('https://images.splitshire.com/full/A-High-Resolution-Christmas-Background-with-Festive-Lights_mVwGn.png') no-repeat center center;
    background-size: cover;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1;
    will-change: transform;
}
.container { text-align:center; width:90%; pointer-events:none; }
h1 { font-size:clamp(2.5rem,10vw,7rem); font-weight:900; color:#fff; -webkit-text-stroke:3px #000; margin:0; text-transform:uppercase; letter-spacing:2px; }
#countdown { font-size:clamp(1.8rem,7vw,5rem); font-weight:900; color:#fff; -webkit-text-stroke:2px #000; font-variant-numeric: tabular-nums; }
.vscode-label { position:fixed; bottom:20px; right:25px; font-size:24px; font-weight:bold; color:#000; z-index:9999; pointer-events:none; user-select:none; text-shadow:1px 1px 0 rgba(255,255,255,0.3);}
.snowflake { position:fixed; top:-10px; color:white; animation:fall linear forwards; z-index:5; pointer-events:none; }
@keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }
#start-audio-btn { position:fixed; left:30px; bottom:30px; z-index:10000; background:#ff0000; color:white; padding:15px 30px; font-size:20px; border-radius:12px; cursor:pointer; border:3px solid white; font-weight:bold; box-shadow:0 0 20px rgba(0,0,0,0.5); pointer-events:auto; }
video#pip-video { display:none; }
</style>
</head>
<body>

<div id="visual-layer">
    <div class="container">
        <h1>Christmas</h1>
        <h1>Countdown</h1>
        <div id="countdown">Calculating...</div>
    </div>
</div>

<div class="vscode-label">This was made in Visual Studio Code</div>
<button id="start-audio-btn">START MUSIC</button>
<video id="pip-video" autoplay muted playsinline></video>

<script>
// ================== Countdown ==================
function updateCountdown(){
    const now=new Date();
    const year=now.getFullYear();
    let christmas=new Date(year,11,25);
    if(now>christmas) christmas=new Date(year+1,11,25);
    const diff=christmas-now;
    const d=Math.floor(diff/(1000*60*60*24));
    const h=Math.floor((diff%(1000*60*60*24))/(1000*60*60));
    const m=Math.floor((diff%(1000*60*60))/(1000*60));
    const s=Math.floor((diff%(1000*60))/1000);
    document.getElementById("countdown").textContent=`${d}d ${h<10?'0'+h:h}h ${m<10?'0'+m:m}m ${s<10?'0'+s:s}s`;
}
setInterval(updateCountdown,1000);
updateCountdown();

// ================== Snow ==================
setInterval(()=>{
    const s=document.createElement("div");
    s.className="snowflake"; s.textContent="â„";
    s.style.left=Math.random()*window.innerWidth+"px";
    s.style.opacity=Math.random();
    s.style.fontSize=(Math.random()*20+10)+"px";
    s.style.animationDuration=(Math.random()*3+4)+"s";
    document.body.appendChild(s);
    setTimeout(()=>s.remove(),7000);
},200);

// ================== Music ==================
const GLOBAL_START_TIME=Date.UTC(2025,11,1,0,0,0);
const FADE_TIME=2;
const audio=new Audio(); audio.preload="metadata"; let audioCtx,analyser,gainNode,source; let started=false; let currentIdx=0;
const visualLayer=document.getElementById("visual-layer");

// Sample playlist (replace with all your songs)
const playlist=[
"Music Now, Trap Music Now, Dance Music Now - All I Want For Christmas Is You (SPOTISAVER).mp3",
"Music Now, Trap Music Now, Dance Music Now - Baby It's Cold Outside (SPOTISAVER).mp3",
"Music Now, Trap Music Now, Dance Music Now - Blue Christmas (SPOTISAVER).mp3",
"Music Now, Trap Music Now, Dance Music Now - Carol Of The Bells (SPOTISAVER).mp3"
];

let trackDurations=[], cumulativeDurations=[];

async function preloadDurations(){
    const promises=playlist.map(f=>{
        return new Promise(res=>{
            const a=new Audio(); a.src="songs/"+f;
            a.addEventListener("loadedmetadata",()=>res(a.duration));
            a.addEventListener("error",()=>res(180));
        });
    });
    trackDurations=await Promise.all(promises);
    cumulativeDurations=[0];
    for(let i=0;i<trackDurations.length;i++) cumulativeDurations.push(cumulativeDurations[i]+trackDurations[i]);
}

function getLiveTrackAndOffset(){
    const elapsed=(Date.now()-GLOBAL_START_TIME)/1000;
    const total=cumulativeDurations[cumulativeDurations.length-1];
    const modTime=elapsed%total;
    let left=0,right=cumulativeDurations.length-1;
    while(left<right-1){ const mid=Math.floor((left+right)/2); if(cumulativeDurations[mid]<=modTime) left=mid; else right=mid; }
    const trackIndex=left;
    const offset=modTime-cumulativeDurations[trackIndex];
    return {trackIndex, offset};
}

function updateMediaSessionTitle(filename){
    const cleanName=filename.replace("Music Now, Trap Music Now, Dance Music Now - ","").replace("(SPOTISAVER).mp3","").trim();
    if('mediaSession' in navigator) navigator.mediaSession.metadata=new MediaMetadata({title:cleanName,artist:"Christmas Countdown"});
}

function playLiveTrack(){
    const {trackIndex, offset}=getLiveTrackAndOffset();
    currentIdx=trackIndex;
    audio.src=encodeURI("songs/"+playlist[currentIdx]);
    audio.onloadedmetadata=()=>{
        audio.currentTime=offset; audio.play(); fadeVolume(1,FADE_TIME);
        updateMediaSessionTitle(playlist[currentIdx]);
    };
    audio.onended=playLiveTrack;
}

function fadeVolume(target,duration){
    gainNode.gain.cancelScheduledValues(audioCtx.currentTime);
    gainNode.gain.linearRampToValueAtTime(target,audioCtx.currentTime+duration);
}

function initVisualizer(){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    audioCtx.resume();
    analyser=audioCtx.createAnalyser(); gainNode=audioCtx.createGain();
    source=audioCtx.createMediaElementSource(audio);
    source.connect(gainNode); gainNode.connect(analyser); analyser.connect(audioCtx.destination);
    analyser.fftSize=256; gainNode.gain.value=0;
    renderFrame();
}

function renderFrame(){
    requestAnimationFrame(renderFrame);
    if(!analyser) return;
    const data=new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(data);
    const bass=data[2]||0; const t=Date.now()*0.003;
    if(visualLayer) visualLayer.style.transform=`scale(${1.05+bass/600}) translateX(${Math.sin(t)*10}px)`;
    if(visualLayer) visualLayer.style.filter=`brightness(${1+bass/350})`;
    if(audio.duration && audio.currentTime>audio.duration-FADE_TIME) fadeVolume(0,FADE_TIME);
}

audio.addEventListener("play",()=>{ if(!started||!audio.duration)return; const {offset}=getLiveTrackAndOffset(); audio.currentTime=offset; updateMediaSessionTitle(playlist[currentIdx]); });
if('mediaSession' in navigator){ navigator.mediaSession.setActionHandler('nexttrack',null); navigator.mediaSession.setActionHandler('previoustrack',null); }

// ================== PiP with CTRL+P ==================
async function setupPiP(){
    const canvas=document.createElement("canvas"); canvas.width=window.innerWidth; canvas.height=window.innerHeight;
    const ctx=canvas.getContext("2d");
    const video=document.getElementById("pip-video");
    const stream=canvas.captureStream(30);
    const audioTrack=audio.captureStream().getAudioTracks()[0]; stream.addTrack(audioTrack);
    video.srcObject=stream; video.play();

    function drawFrame(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(document.getElementById("visual-layer"),0,0,canvas.width,canvas.height);
        requestAnimationFrame(drawFrame);
    }
    drawFrame();

    document.addEventListener("keydown", async (e)=>{
        if(e.ctrlKey && e.key.toLowerCase()==='p'){
            e.preventDefault();
            if(video!==document.pictureInPictureElement){
                try{ await video.requestPictureInPicture(); } catch(err){ console.warn(err); }
            } else {
                await document.exitPictureInPicture();
            }
        }
    });
}

// ================== START BUTTON ==================
document.getElementById("start-audio-btn").onclick=async ()=>{
    if(started) return; started=true;
    initVisualizer(); await preloadDurations(); playLiveTrack(); setupPiP();
    document.getElementById("start-audio-btn").remove();
};
</script>

</body>
</html>
